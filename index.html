
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>chendo</title>
	<meta name="author" content="chendo">

	
	<meta name="description" content="Jul 12th, 2015 debugging, tools Live Wireshark session from remote machine I was tasked to debug some network stack issues last week at work which &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="chendo" type="application/atom+xml">
	
	<link rel="canonical" href="http://chendo.github.io/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	<img src="http://www.gravatar.com/avatar/e2dc9b044425e2df0a07873b0b65693e?s=160" alt="Profile Picture" style="width: 160px" />
</div>
<hgroup>
  <h1><a href="/">chendo</a></h1>
</hgroup>

<p class="subtitle">chendo is a software engineer, gadget enthusiast and problem solver. Lives in Melbourne, Australia.</p>
<nav id="main-nav"><ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="https://assemblyfour.com/">Assembly Four</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/chendo" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/chendo" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-07-12T14:16:00+10:00" data-updated="true" itemprop="datePublished">Jul 12<span>th</span>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/debugging/'>debugging</a>, <a class='category' href='/blog/categories/tools/'>tools</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/07/12/live-wireshark-session-from-remote-machine/" itemprop="url">Live Wireshark session from remote machine</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>I was tasked to debug some network stack issues last week at work which required intercepting wireless traffic at the router. Previously, I would use my Macbook to share internet through an Ethernet port, and then open a Wireshark session on <code>bridge100</code> to look at traffic this way.</p>

<p>However, this is usually a pain because the internet sharing feature tends to break for me which ends up in a reboot to resolve the issue, as well as having to mess with cables. We switched out the wireless router with one that was running OpenWRT with <code>tcpdump</code> installed, and other engineers used to ssh in, run <code>tcpdump</code> on the router, then copy the file down locally and then opening it up Wireshark.</p>

<p>I prefer to be able to see the packets live, so I hunted around and came across a fairly simple solution. You&rsquo;ll need:</p>

<ul>
<li>OS X or Linux. Cygwin might work but who knows? (or cares)</li>
<li>ssh access to remote machine</li>
<li><code>tcpdump</code> and ability to access the appropriate interface on the remote machine</li>
<li>Wireshark installed locally</li>
</ul>


<p>Run: <code>wireshark -k -i &lt;(ssh [remote machine] sudo tcpdump -i [interface name] -S -l -w - “[dump filter]”)</code></p>

<p>The dump filter is optional. If it worked correctly, you should see Wireshark pop up and packets start to come in. You may need to scroll to the bottom of the list before it starts to auto-scroll.</p>

<p>Enjoy!</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-10-11T17:51:00+11:00" data-updated="true" itemprop="datePublished">Oct 11<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/debugging/'>debugging</a>, <a class='category' href='/blog/categories/osx/'>osx</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/10/11/simulating-out-of-order-packets-on-os-x/" itemprop="url">Simulating out of order packets on OS X</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>I needed a way to simulate out of order packets in order to try to reproduce an issue I&rsquo;ve been seeing at work, and I figured out a fairly simple way that only involves <code>ipfw</code> which is built-in on 10.9 but unfortunately has been removed in 10.10. The same technique should be adaptable to <code>pfctl</code> though.</p>

<h2>Step 1 &ndash; Creating a pipe</h2>

<p>To be able to simulate out of order packets, you must create a pipe in <code>ipfw</code> with a rule that matches the traffic you&rsquo;re trying to affect.</p>

<p><code>sudo ipfw add 1 pipe 1 ip from &lt;host&gt; to me</code></p>

<p>You must create another pipe if you want to affect traffic in the opposite direction.</p>

<p><code>sudo ipfw add 2 pipe 1 ip from me to &lt;host&gt;</code></p>

<h2>Step 2 &ndash; Simulate out of order packets</h2>

<p><code>ipfw</code> lets you set a bunch of config options on traffic flowing through a pipe. You can limit the amount of bandwidth with <code>bw &lt;speed&gt;</code>, packet loss with <code>plr &lt;rate&gt;</code>, and latency with <code>delay &lt;time&gt;</code>.</p>

<p>So to simulate 1 second latency, we would run:</p>

<p><code>sudo ipfw pipe 1 config delay 1s</code></p>

<p>However, this doesn&rsquo;t simulate out of order packets by itself. You can simulate packet loss which can induce out of order packets with:</p>

<p><code>sudo ipfw pipe 1 config plr 0.05 # 5% packet loss</code></p>

<p>But I believe I found a better solution (IMO) by constantly setting the delay to random values every couple of milliseconds.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>sudo ruby -e "loop { \\`ipfw pipe 1 config delay #{rand(500) + 100}ms\\`; sleep 0.01 }"</span></code></pre></td></tr></table></div></figure>


<p>where the delay is randomly set to (0-500) + 100ms every 10ms.</p>

<h2>Step 3 &ndash; Clean up</h2>

<p>Once you&rsquo;re done with your testing, be sure to remove the rules.</p>

<p><code>sudo ipfw del 1</code></p>

<h2>Conclusion</h2>

<p>This worked well enough for me, and I hope it helps you too. If someone figures out how to do this with <code>pfctl</code> on 10.10, please let me know!</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-10-22T16:52:00+11:00" data-updated="true" itemprop="datePublished">Oct 22<span>nd</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/dtrace/'>dtrace</a>, <a class='category' href='/blog/categories/process/'>process</a>, <a class='category' href='/blog/categories/xcode/'>xcode</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/10/22/reverse-engineering-xcode-with-dtrace/" itemprop="url">Reverse engineering Xcode with dtrace</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Both OS X and iOS tend to have a love-hate relationship with Xcode. Crashing, lacking solid refactoring tools, some UX failures, and so on.</p>

<p>For me, it is/<a href="https://github.com/chendo/FuzzyAutocompletePlugin">was</a> the lack of a good autocomplete that really ticks me off. Xcode&rsquo;s autocomplete is prefix-based, so Xcode will only show completions where the start of the completion matches your incomplete word. This is rather frustrating, as the prefix for completion items tends to be the same.</p>

<p>For example, if you wanted to complete <code>NSAccessibilityRoleDescriptionForUIElement</code>, you&rsquo;d probably go:</p>

<ul>
<li><code>nsacc&lt;TAB&gt;</code> to get <code>NSAccessibility</code></li>
<li><code>ro&lt;TAB&gt;</code> to get <code>NSAccessibilityRole</code></li>
<li><code>des&lt;TAB&gt;</code> to get <code>NSAccessibilityRoleDescription</code></li>
<li>and finally <code>f&lt;TAB&gt;</code> to get <code>NSAccessibilityRoleDescriptionForUIElement</code></li>
</ul>


<p>Of course, you can always use arrow keys to scroll through the list at some point to select it, but using arrow keys isn&rsquo;t a great solution.</p>

<p>It would be great if Xcode supported fuzzy autocompletion (like Sublime Text, AppCode, etc etc). I mentioned this to <a href="https://twitter.com/alanjrogers">@alanjrogers</a> one Friday afternoon and he told me I should write an Xcode plugin for it.</p>

<p>Why not?</p>

<h2>Step 1: Making a plugin for Xcode 5</h2>

<p>I found BlackDog Foundry&rsquo;s <a href="http://www.blackdogfoundry.com/blog/creating-an-xcode4-plugin/">Creating an Xcode 4 Plugin</a> which got me off to a good start where I was able to get code loaded into Xcode 5, with a couple of Xcode 5-specific <code>Info.plist</code> UUID tweaks from <a href="https://github.com/ricobeck/KFCocoaPodsPlugin">KFCocoaPodsPlugin</a>.</p>

<h2>Step 2: Figure out what to hook into</h2>

<p>With <code>class-dump</code>, I dumped <code>Xcode.app</code>&rsquo;s classes and started searching for likely places to hook into. I stumbled across the <code>DVTTextCompletion*</code> class cluster which was a good place to start. Before you can use the dumped headers, you need to remove the <code>- (void).cxx_destruct</code> method declaration if it exists. You also need to remove some <code>#import</code> statements that cause the build to fail, like <code>#import &lt;objc/NSObject.h&gt;</code> and <code>AppKit</code> imports.</p>

<p>I added <code>JRSwizzle</code> with CocoaPods and started to poke at some classes I thought would be a good start, like <code>DVTTextCompletionSession</code>.</p>

<p>Unfortunately, this didn&rsquo;t get me very far. Picking random methods to swizzle was a time consuming process which involved lots of restarting of Xcode. I needed a better way to figure out what I should hook into.</p>

<p>Some googling turned up the <code>NSObjCMessageLoggingEnabled</code> environment variable, where it would log every message send to <code>/tmp/msgSend-&lt;pid&gt;</code>. Unfortunately, starting up Xcode generated about 15 million lines of data (a whopping <strong>659MB!!</strong>), so that clearly wasn&rsquo;t what I was after.</p>

<h2><code>dtrace</code> to the rescue</h2>

<p>I found a little <code>dtrace</code> snippet on <a href="http://stackoverflow.com/a/10749819/2860998">Stackoverflow</a> which would let you probe message sends of a certain class, which gave me a much better indication of what I should be looking at (after tracing <code>DVTTextCompletionSession</code>), however it only output the method calls without any context.</p>

<p>Further googling turned up an article by Jon Haslam on <a href="https://blogs.oracle.com/jonh/entry/dtrace_and_visualisation">DTrace and Visualisation</a>, where he described using the <code>flowindent</code> option on <code>dtrace</code> to show a call tree. This was better, but it was limited to showing the method name only unless you used <code>printf</code> to show the class. It was messy and not ideal.</p>

<p>I eventually found <a href="http://stackoverflow.com/a/16242756/2860998">this script</a> that essentially reimplemented <code>flowindent</code> but with a better visualisatino of Objective-C method calls.</p>

<p>I modified it to provide better indentation and allow scoping down to a certain class. Script is below:</p>

<figure class='code'><figcaption><span>trace_msg_send.sh</span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='d'><span class='line'><span class="err">#</span><span class="p">!/</span><span class="n">usr</span><span class="p">/</span><span class="n">sbin</span><span class="p">/</span><span class="n">dtrace</span> <span class="p">-</span><span class="n">s</span>
</span><span class='line'><span class="err">#</span><span class="k">pragma</span> <span class="n">D</span> <span class="n">option</span> <span class="n">quiet</span>
</span><span class='line'>
</span><span class='line'><span class="n">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">indention</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">indentation_amount</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">BEGIN</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">indentation_amount</span> <span class="p">=</span> <span class="mi">4</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">objc</span><span class="p">$</span><span class="n">target</span><span class="p">:$</span><span class="mi">1</span><span class="p">::</span><span class="n">entry</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">method</span> <span class="p">=</span> <span class="p">(</span><span class="nb">string</span><span class="p">)&amp;</span><span class="n">probefunc</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="n">type</span> <span class="p">=</span> <span class="n">probefunc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="k">class</span> <span class="p">=</span> <span class="n">probemod</span><span class="p">;</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%*s%s %c[%s %s]\n&quot;</span><span class="p">,</span> <span class="n">indention</span> <span class="p">*</span> <span class="n">indentation_amount</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">class</span><span class="p">,</span> <span class="n">method</span><span class="p">);</span>
</span><span class='line'>    <span class="n">indention</span><span class="p">++;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">objc</span><span class="p">$</span><span class="n">target</span><span class="p">:$</span><span class="mi">1</span><span class="p">::</span><span class="k">return</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">indention</span><span class="p">--;</span>
</span><span class='line'>    <span class="n">method</span> <span class="p">=</span> <span class="p">(</span><span class="nb">string</span><span class="p">)&amp;</span><span class="n">probefunc</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="n">type</span> <span class="p">=</span> <span class="n">probefunc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="k">class</span> <span class="p">=</span> <span class="n">probemod</span><span class="p">;</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%*s%s %c[%s %s]\n&quot;</span><span class="p">,</span> <span class="n">indention</span> <span class="p">*</span> <span class="n">indentation_amount</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&lt;-&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">class</span><span class="p">,</span> <span class="n">method</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Usage: <code>sudo ./trace_msg_send.sh -p &lt;pid of app&gt; &lt;objc class&gt;</code></p>

<p>This produced a much better looking and easier to understand call tree:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="nl">initWithTextView:atLocation:cursorLocation:</span><span class="p">]</span>
</span><span class='line'><span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="nl">initWithTextView:atLocation:cursorLocation:</span><span class="p">]</span>
</span><span class='line'><span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="nl">showCompletionsExplicitly:</span><span class="p">]</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">isShowingCompletions</span><span class="p">]</span>
</span><span class='line'>    <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">isShowingCompletions</span><span class="p">]</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">_ensureCompletionsUpToDate</span><span class="p">]</span>
</span><span class='line'>        <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">textView</span><span class="p">]</span>
</span><span class='line'>        <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">textView</span><span class="p">]</span>
</span><span class='line'>        <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">textView</span><span class="p">]</span>
</span><span class='line'>        <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">textView</span><span class="p">]</span>
</span><span class='line'>    <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">_ensureCompletionsUpToDate</span><span class="p">]</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">textView</span><span class="p">]</span>
</span><span class='line'>    <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">textView</span><span class="p">]</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="nl">setPendingRequestState:</span><span class="p">]</span>
</span><span class='line'>        <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">readyToShowCompletions</span><span class="p">]</span>
</span><span class='line'>            <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">filteredCompletionsAlpha</span><span class="p">]</span>
</span><span class='line'>            <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">filteredCompletionsAlpha</span><span class="p">]</span>
</span><span class='line'>        <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">readyToShowCompletions</span><span class="p">]</span>
</span><span class='line'>    <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="nl">showCompletionsExplicitly:</span><span class="p">]</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">isShowingCompletions</span><span class="p">]</span>
</span><span class='line'>    <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">isShowingCompletions</span><span class="p">]</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="nl">setAllCompletions:</span><span class="p">]</span>
</span><span class='line'>    <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="nl">setAllCompletions:</span><span class="p">]</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">_prefixForCurrentLocation</span><span class="p">]</span>
</span><span class='line'>        <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">textView</span><span class="p">]</span>
</span><span class='line'>        <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">textView</span><span class="p">]</span>
</span><span class='line'>    <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">_prefixForCurrentLocation</span><span class="p">]</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="nl">_setFilteringPrefix:forceFilter:</span><span class="p">]</span>
</span><span class='line'>        <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">allCompletions</span><span class="p">]</span>
</span><span class='line'>        <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="n">allCompletions</span><span class="p">]</span>
</span><span class='line'>        <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="nl">_bestMatchInSortedArray:usingPrefix:</span><span class="p">]</span>
</span><span class='line'>        <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="nl">_bestMatchInSortedArray:usingPrefix:</span><span class="p">]</span>
</span><span class='line'>        <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="nl">_usefulPartialCompletionPrefixForItems:selectedIndex:filteringPrefix:</span><span class="p">]</span>
</span><span class='line'>            <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="nl">_commonPrefixForItems:</span><span class="p">]</span>
</span><span class='line'>                <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="nl">rangeOfFirstWordInString:</span><span class="p">]</span>
</span><span class='line'>                <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionSession</span> <span class="nl">rangeOfFirstWordInString:</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h4>A quick breakdown of a <code>dtrace</code> probe</h4>

<p>A <code>dtrace</code> probe is defined by <code>provider:module:function:name</code>. In the above script, I use <code>objc$target:$1::entry</code>. <code>$target</code> is a macro variable which is filled in by <code>pid</code> passed in by the command line via the <code>-p</code> flag. <code>$1</code>, <code>$2</code> and so forth are the arguments passed into <code>dtrace</code>.</p>

<p>Example: <code>sudo ./trace_msg_send.sh -p 12345 DVTTextCompletionSession</code></p>

<ul>
<li>Provider: objc12345</li>
<li>Module: DVTTextCompletionSession</li>
<li>Function: [everything]</li>
<li>Name: entry</li>
</ul>


<p>This will match all method entry events within <code>DVTTextCompletionSession</code> for pid 12345.</p>

<p><code>dtrace</code> supports wildcards: <code>*</code> for multiple characters, <code>?</code> for a single character.</p>

<p>For a more detailed rundown on <code>dtrace</code>, see <a href="http://blog.bignerdranch.com/1907-hooked-on-dtrace-part-1/">Hooked on DTrace</a></p>

<h2>Step 3: Find out what Xcode is doing</h2>

<p>A quick swizzle of <code>setAllCompletions:</code> showed that Xcode sets the completion list to whatever is autocompletable at a particular scope. On a new line, it would set all the constants, C methods, macros, etc etc, which ended to be about 40,000. When autocompleting on <code>[self</code> on one of my plugin classes, it set the completion list to a much more managable 278.</p>

<p>After some digging, I found that <code>_setFilteringPrefix:forceFilter:</code> did what I expected and was called every time the user typed. A few hours of trial and error later, I managed to hook up Xcode&rsquo;s own <code>IDEOpenQuicklyPattern</code> class to perform fuzzy filtering of the completions, but I still relied on calling the original fuzzy matching method because otherwise the autocompletion list window would not update correctly. This was adding 30-50ms of execution time on the main thread, which is not ideal, so the next step is to figure out what Xcode is doing behind the scenes to update this.</p>

<p><code>DVTTextCompletionListWindowController</code> is probably what I wanted to look at, but using the same script wasn&rsquo;t useful as it was filled with <code>-[DVTTextCompletionListWindowController tableView:objectValueForTableColumn:row:]</code> calls, and it was missing a return call so the indentation kept growing.</p>

<p>I wrote another script that let me filter out the method calls I didn&rsquo;t want polluting my trace, and added the ability to only trace message sends within a certain method.</p>

<figure class='code'><figcaption><span>trace_within_method_and_filter.sh</span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='d'><span class='line'><span class="err">#</span><span class="p">!/</span><span class="n">usr</span><span class="p">/</span><span class="n">sbin</span><span class="p">/</span><span class="n">dtrace</span> <span class="p">-</span><span class="n">s</span>
</span><span class='line'><span class="err">#</span><span class="k">pragma</span> <span class="n">D</span> <span class="n">option</span> <span class="n">quiet</span>
</span><span class='line'>
</span><span class='line'><span class="n">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">indention</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">indentation_amount</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">BEGIN</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">indentation_amount</span> <span class="p">=</span> <span class="mi">4</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* the : in method selectors must be replaced with ? */</span>
</span><span class='line'><span class="n">objc</span><span class="p">$</span><span class="n">target</span><span class="p">:</span><span class="n">DVTTextCompletionSession</span><span class="p">:-</span><span class="n">_setFilteringPrefix</span><span class="p">?</span><span class="n">forceFilter</span><span class="p">?:</span><span class="n">entry</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">tracing</span><span class="p">++;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">objc</span><span class="p">$</span><span class="n">target</span><span class="p">:</span><span class="n">DVTTextCompletionSession</span><span class="p">:-</span><span class="n">_setFilteringPrefix</span><span class="p">?</span><span class="n">forceFilter</span><span class="p">?:</span><span class="k">return</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">tracing</span><span class="p">--;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">objc</span><span class="p">$</span><span class="n">target</span><span class="p">:</span><span class="n">DVTTextCompletionList</span><span class="p">*::</span><span class="n">entry</span>
</span><span class='line'><span class="p">/</span>
</span><span class='line'>    <span class="n">tracing</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">&amp;&amp;</span>
</span><span class='line'>    <span class="p">&amp;</span><span class="n">probefunc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">!=</span> <span class="s">&quot;tableView:willDisplayCell:forTableColumn:row:&quot;</span> <span class="p">&amp;&amp;</span>
</span><span class='line'>    <span class="p">&amp;</span><span class="n">probefunc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">!=</span> <span class="s">&quot;tableView:objectValueForTableColumn:row:&quot;</span>
</span><span class='line'><span class="p">/</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">method</span> <span class="p">=</span> <span class="p">(</span><span class="nb">string</span><span class="p">)&amp;</span><span class="n">probefunc</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="n">type</span> <span class="p">=</span> <span class="n">probefunc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="k">class</span> <span class="p">=</span> <span class="n">probemod</span><span class="p">;</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%lu %*s%s %c[%s %s]\n&quot;</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">indention</span> <span class="p">*</span> <span class="n">indentation_amount</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">class</span><span class="p">,</span> <span class="n">method</span><span class="p">);</span>
</span><span class='line'>    <span class="n">indention</span><span class="p">++;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">objc</span><span class="p">$</span><span class="n">target</span><span class="p">:</span><span class="n">DVTTextCompletionList</span><span class="p">*::</span><span class="k">return</span>
</span><span class='line'><span class="p">/</span>
</span><span class='line'>    <span class="n">tracing</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">&amp;&amp;</span>
</span><span class='line'>    <span class="p">&amp;</span><span class="n">probefunc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">!=</span> <span class="s">&quot;tableView:willDisplayCell:forTableColumn:row:&quot;</span> <span class="p">&amp;&amp;</span>
</span><span class='line'>    <span class="p">&amp;</span><span class="n">probefunc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">!=</span> <span class="s">&quot;tableView:objectValueForTableColumn:row:&quot;</span>
</span><span class='line'><span class="p">/</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">indention</span><span class="p">--;</span>
</span><span class='line'>    <span class="n">method</span> <span class="p">=</span> <span class="p">(</span><span class="nb">string</span><span class="p">)&amp;</span><span class="n">probefunc</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="n">type</span> <span class="p">=</span> <span class="n">probefunc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="k">class</span> <span class="p">=</span> <span class="n">probemod</span><span class="p">;</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%lu %*s%s %c[%s %s]\n&quot;</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">indention</span> <span class="p">*</span> <span class="n">indentation_amount</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&lt;-&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">class</span><span class="p">,</span> <span class="n">method</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I added timestamps to the result because the output kept ending out of order.</p>

<p>I ran with <code>sudo ./trace_within_method_and_filter.sh -p</code>pidof xcode<code>&gt; output.txt</code>, then fixed the order and removed timestamps with <code>cat output.txt | sort -n | cut -c 17-200</code>.</p>

<p>Output with calls to stuff to properties (<code>window</code>, <code>session</code>, and <code>showingWindow</code>) with no inner method calls removed for brevity:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="nl">initWithSession:</span><span class="p">]</span>
</span><span class='line'><span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="nl">initWithSession:</span><span class="p">]</span>
</span><span class='line'><span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="nl">showWindowForTextFrame:explicitAnimation:</span><span class="p">]</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">window</span><span class="p">]</span>
</span><span class='line'>        <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">windowDidLoad</span><span class="p">]</span>
</span><span class='line'>            <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">_loadColorsFromCurrentTheme</span><span class="p">]</span>
</span><span class='line'>                <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">_iconShadow</span><span class="p">]</span>
</span><span class='line'>                <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">_iconShadow</span><span class="p">]</span>
</span><span class='line'>                <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="nl">numberOfRowsInTableView:</span><span class="p">]</span>
</span><span class='line'>                <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="nl">numberOfRowsInTableView:</span><span class="p">]</span>
</span><span class='line'>            <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">windowDidLoad</span><span class="p">]</span>
</span><span class='line'>        <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">window</span><span class="p">]</span>
</span><span class='line'>        <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="nl">numberOfRowsInTableView:</span><span class="p">]</span>
</span><span class='line'>        <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="nl">numberOfRowsInTableView:</span><span class="p">]</span>
</span><span class='line'>        <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">_updateSelectedRow</span><span class="p">]</span>
</span><span class='line'>            <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="nl">tableViewSelectionDidChange:</span><span class="p">]</span>
</span><span class='line'>            <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">_updateSelectedRow</span><span class="p">]</span>
</span><span class='line'>            <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">_updateCurrentDisplayState</span><span class="p">]</span>
</span><span class='line'>                <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="nl">_getTitleColumnWidth:typeColumnWidth:</span><span class="p">]</span>
</span><span class='line'>                    <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="nl">_preferredWindowFrameForTextFrame:columnsWidth:titleColumnX:</span><span class="p">]</span>
</span><span class='line'>                    <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="nl">_preferredWindowFrameForTextFrame:columnsWidth:titleColumnX:</span><span class="p">]</span>
</span><span class='line'>                <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">_updateCurrentDisplayState</span><span class="p">]</span>
</span><span class='line'>                <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">_updateSelectedRow</span><span class="p">]</span>
</span><span class='line'>                <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="nl">setHideReason:</span><span class="p">]</span>
</span><span class='line'>                    <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">_usefulPrefixAttributes</span><span class="p">]</span>
</span><span class='line'>                    <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">_usefulPrefixAttributes</span><span class="p">]</span>
</span><span class='line'>                    <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">_updateInfoNewSelection</span><span class="p">]</span>
</span><span class='line'>                        <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">showInfoForSelectedCompletionItem</span><span class="p">]</span>
</span><span class='line'>                            <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">_selectedCompletionItem</span><span class="p">]</span>
</span><span class='line'>                            <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">_selectedCompletionItem</span><span class="p">]</span>
</span><span class='line'>                            <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="nl">showInfoPaneForCompletionItem:</span><span class="p">]</span>
</span><span class='line'>                                <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">_selectedCompletionItem</span><span class="p">]</span>
</span><span class='line'>                                <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">_selectedCompletionItem</span><span class="p">]</span>
</span><span class='line'>                                <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">_updateCurrentDisplayStateForQuickHelp</span><span class="p">]</span>
</span><span class='line'>                                    <span class="o">-&gt;</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">_usefulPrefixAttributes</span><span class="p">]</span>
</span><span class='line'>                                    <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">_usefulPrefixAttributes</span><span class="p">]</span>
</span><span class='line'>                                <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="nl">showInfoPaneForCompletionItem:</span><span class="p">]</span>
</span><span class='line'>                            <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="n">showInfoForSelectedCompletionItem</span><span class="p">]</span>
</span><span class='line'>                        <span class="o">&lt;-</span> <span class="o">-</span><span class="p">[</span><span class="n">DVTTextCompletionListWindowController</span> <span class="nl">showWindowForTextFrame:explicitAnimation:</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The call stack is missing some return traces and I&rsquo;m not sure why yet, but we&rsquo;ve found some relevant methods: <code>_updateCurrentDisplayState</code> and <code>_updateSelectedRow</code>. I wasn&rsquo;t having issues with the row updating, so I grabbed a reference to <code>DVTTextCompletionListWindowController</code> with <code>[self _listWindowController]</code> and call <code>-_updateCurrentDisplayState</code>. This solved the display issue!</p>

<p><code>dtrace</code> is pretty awesome, but editing <code>dtrace</code> scripts was annoying. If I have to do more of this, I&rsquo;d probably write a wrapper using <a href="https://github.com/chrisa/ruby-dtrace">ruby-dtrace</a> to help automate filtering etc.</p>

<h1>FuzzyAutocomplete Plugin for Xcode</h1>

<p>The end product is <a href="https://github.com/chendo/FuzzyAutocompletePlugin">FuzzyAutocomplete</a> (<a href="https://github.com/chendo/FuzzyAutocompletePlugin">github.com/chendo/FuzzyAutocompletePlugin</a>), which works in Xcode 5. It shouldn&rsquo;t conflict with any existing plugins like <a href="https://github.com/ksuther/KSImageNamed-Xcode">KSImageNamed</a> as most plugins expose additional completion items rather than change the filtering.</p>

<p>You can install it with <a href="http://mneorr.github.io/Alcatraz/">Alcatraz</a> or by cloning it and building it yourself. See the <a href="https://github.com/chendo/FuzzyAutocompletePlugin">project on Github</a> for more info.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-10-04T18:38:00+10:00" data-updated="true" itemprop="datePublished">Oct 4<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/rubymotion/'>rubymotion</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/10/04/building-a-command-line-os-x-app-with-rubymotion/" itemprop="url">Building a Command Line OS X app with RubyMotion</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>I decided to write a command line tool with <a href="http://rubymotion.com/">RubyMotion</a> to <a href="http://chen.do/blog/2013/10/04/visualising-rects-from-lldb/">visualise CGRects and NSRects from lldb</a>, but I quickly discovered that RubyMotion does not support this out of the box.</p>

<p>You can build an OS X app that doesn&rsquo;t present a UI by by setting <code>LSUIElement</code> to <code>true</code> and not creating any UI, but when you copy the binary out of the bundle and try to run it, you get an error that looks something like this:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>drawrect[59471:707] No Info.plist file in application bundle or no NSPrincipalClass in the Info.plist file, exiting</span></code></pre></td></tr></table></div></figure>


<p>This is due to the <code>NSApplicationMain</code> function not being able to find an <code>Info.plist</code> due to the binary no longer residing inside a bundle. We need to tweak RubyMotion&rsquo;s compile process to skip this method.</p>

<h2>Replacing <code>NSApplicationMain</code></h2>

<p>I tracked down the offending snippet of code within <a href="https://github.com/HipByte/RubyMotion/blob/794b0506af099ca965d666ca1176a92979854259/lib/motion/project/template/osx/config.rb#L188-L214"><code>lib/motion/project/template/osx/config.rb</code></a>.</p>

<figure class='code'><figcaption><span>config.rb</span><a href='https://github.com/HipByte/RubyMotion/blob/794b0506af099ca965d666ca1176a92979854259/lib/motion/project/template/osx/config.rb#L188-L214' title='Download code'> link</a></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">main_txt</span> <span class="o">&lt;&lt;</span> <span class="o">&lt;&lt;</span><span class="no">EOS</span>
</span><span class='line'><span class="sh">int</span>
</span><span class='line'><span class="sh">main(int argc, char **argv)</span>
</span><span class='line'><span class="sh">{</span>
</span><span class='line'><span class="sh">    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];</span>
</span><span class='line'><span class="no">EOS</span>
</span><span class='line'>    <span class="k">if</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;ARR_CYCLES_DISABLE&#39;</span><span class="o">]</span>
</span><span class='line'>      <span class="n">main_txt</span> <span class="o">&lt;&lt;</span> <span class="o">&lt;&lt;</span><span class="no">EOS</span>
</span><span class='line'><span class="sh">    setenv(&quot;ARR_CYCLES_DISABLE&quot;, &quot;1&quot;, true);</span>
</span><span class='line'><span class="no">EOS</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">main_txt</span> <span class="o">&lt;&lt;</span> <span class="o">&lt;&lt;</span><span class="no">EOS</span>
</span><span class='line'><span class="sh">    RubyMotionInit(argc, argv);</span>
</span><span class='line'><span class="sh">    NSApplication *app = [NSApplication sharedApplication];</span>
</span><span class='line'><span class="sh">    [app setDelegate:[NSClassFromString(@&quot;#{delegate_class}&quot;) new]];</span>
</span><span class='line'><span class="no">EOS</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">spec_mode</span>
</span><span class='line'>      <span class="n">main_txt</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;SpecLauncher *specLauncher = [[SpecLauncher alloc] init];</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">main_txt</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;[[NSNotificationCenter defaultCenter] addObserver:specLauncher selector:@selector(appLaunched:) name:NSApplicationDidFinishLaunchingNotification object:nil];</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">main_txt</span> <span class="o">&lt;&lt;</span> <span class="o">&lt;&lt;</span><span class="no">EOS</span>
</span><span class='line'><span class="sh">    NSApplicationMain(argc, (const char **)argv);</span>
</span><span class='line'><span class="sh">    [pool release];</span>
</span><span class='line'><span class="sh">    rb_exit(0);</span>
</span><span class='line'><span class="sh">    return 0;</span>
</span><span class='line'><span class="sh">}</span>
</span><span class='line'><span class="no">EOS</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see on line 139, it calls <code>NSApplicationMain</code> which is the source of the error we&rsquo;re seeing as <code>NSApplicationMain</code> tries to load the NIB as well as construct the application object. See <a href="http://www.cocoawithlove.com/2009/01/demystifying-nsapplication-by.html">Matt Gallager&rsquo;s article on NSApplicationMain</a> for more details.</p>

<h2>Patching RubyMotion&rsquo;s compile step</h2>

<p>We could do this one of two ways:</p>

<ul>
<li>Create a new OS X command line template</li>
<li>Monkey-patch the Config class</li>
</ul>


<p>Given I&rsquo;m kinda lazy, monkey-patching the config class was the way to go for me :)</p>

<p>Make a directory called <code>lib</code> in the root of the RubyMotion project, and make a file named <code>osx_cli.rb</code>.</p>

<p>We need to patch the <code>main_cpp_file_txt</code> method of the <code>Motion::Project::OSXConfig</code> class, so your file should look something like this:</p>

<figure class='code'><figcaption><span>osx_cli.rb</span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Motion::Project</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">OSXConfig</span> <span class="o">&lt;</span> <span class="no">XcodeConfig</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">main_cpp_file_txt</span><span class="p">(</span><span class="n">spec_objs</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you want to paste the original method body in, and then we can start patching!</p>

<p>Let&rsquo;s remove the <code>NSApplicationMain</code> call as we won&rsquo;t be needing that (yet).</p>

<p>Command line applications don&rsquo;t need an application delegate either, so let&rsquo;s delete the following lines:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>    <span class="n">NSApplication</span> <span class="o">*</span><span class="n">app</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSApplication</span> <span class="n">sharedApplication</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">app</span> <span class="nl">setDelegate:</span><span class="p">[</span><span class="n">NSClassFromString</span><span class="p">(</span><span class="s">@&quot;#{delegate_class}&quot;</span><span class="p">)</span> <span class="n">new</span><span class="p">]];</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, we still need an entry point into our Ruby code. Let&rsquo;s use the pre-existing <code>delegate_class</code> variable to define the entry point class.</p>

<figure class='code'><figcaption><span>osx_cli.rb </span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">main_txt</span> <span class="o">&lt;&lt;</span> <span class="o">&lt;&lt;</span><span class="no">EOS</span>
</span><span class='line'><span class="sh">    [[NSClassFromString(@&quot;#{delegate_class}&quot;) new] main];</span>
</span><span class='line'><span class="sh">    [pool release];</span>
</span><span class='line'><span class="sh">    rb_exit(0);</span>
</span><span class='line'><span class="sh">    return 0;</span>
</span><span class='line'><span class="sh">}</span>
</span><span class='line'><span class="no">EOS</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now rather than calling <code>NSApplicationMain</code>, we&rsquo;re now calling the <code>main</code> instance method on the application delegate class (which is <code>AppDelegate</code> by default).</p>

<p>To make RubyMotion actually pick our code up, we need to <code>require</code> it in the <code>Rakefile</code>.</p>

<figure class='code'><figcaption><span>Rakefile</span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># -*- coding: utf-8 -*-</span>
</span><span class='line'><span class="vg">$:</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="s2">&quot;/Library/RubyMotion/lib&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;motion/project/template/osx&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;lib/osx_cli&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;bundler&#39;</span>
</span><span class='line'>  <span class="no">Bundler</span><span class="o">.</span><span class="n">require</span>
</span><span class='line'><span class="k">rescue</span> <span class="no">LoadError</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="ss">Motion</span><span class="p">:</span><span class="ss">:Project</span><span class="o">::</span><span class="no">App</span><span class="o">.</span><span class="n">setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">app</span><span class="o">|</span>
</span><span class='line'>  <span class="c1"># Use `rake config&#39; to see complete project settings.</span>
</span><span class='line'>  <span class="n">app</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;drawrect&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>When you run your app, it should now call <code>AppDelegate#main</code>!</p>

<h2>What if I still need a run loop?</h2>

<p>I thought I was home scot-free at this point, however when I tried to initialize a <code>NSWindow</code> in the daemon component of <code>drawrect</code>, I ran into these errors:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>drawrect[61361:707] _NXCreateWindowWithStyleMask: error setting window property (1000)
</span><span class='line'>drawrect[61361:707] error [1000] setting colorSpace to DELL 3008WFP colorspace
</span><span class='line'>drawrect[61361:707] PSsetwindowlevel, error setting window level (1000)
</span><span class='line'>drawrect[61361:707] _NSSetWindowTag, error clearing window tags (1000)
</span><span class='line'>drawrect[61361:707] _NSSetWindowTag, error setting window tags (1000)
</span><span class='line'>drawrect[61361:707] error [1000] getting window resolution
</span><span class='line'>drawrect[61361:707] Error [1000] setting resolution to 1
</span><span class='line'>drawrect[61361:707] _NSShapePlainWindowWithOpaqueRect: error setting window shape (1000)
</span><span class='line'>drawrect[61361:707] CGSAddSurface failed - error 1000 (windowID:4017)
</span><span class='line'>drawrect[61361:707] CGSAddSurface failed - error 1000 (windowID:4017)</span></code></pre></td></tr></table></div></figure>


<p>These errors are occuring because the app no longer has a connection to the window server since we have removed the <code>[NSApplication sharedApplication]</code> line, which connects the app to the window server.</p>

<p>All we need to do is call <code>NSApplication.sharedApplication</code> and run the main event loop:</p>

<figure class='code'><figcaption><span>app_delegate.rb</span><a href='https://github.com/chendo/drawrect/blob/master/app/app_delegate.rb' title='Download code'> link</a></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">def</span> <span class="nf">bootServer!</span>
</span><span class='line'>    <span class="n">app</span> <span class="o">=</span> <span class="no">NSApplication</span><span class="o">.</span><span class="n">sharedApplication</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">NSApp</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">applicationDidFinishLaunching</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
</span><span class='line'>    <span class="no">DrawRect</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">listen</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And boom, everything works! <code>drawrect</code> is now a self-contained command line application that has the ability to create windows and doesn&rsquo;t have to reside in an app bundle.</p>

<p>Check out the <code>drawrect</code> project at <a href="https://github.com/chendo/drawrect">https://github.com/chendo/drawrect</a> for a fully functioning example.</p>

<p>Let me know if this has been useful to you!</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-10-04T16:38:00+10:00" data-updated="true" itemprop="datePublished">Oct 4<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/lldb/'>lldb</a>, <a class='category' href='/blog/categories/tools/'>tools</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/10/04/visualising-rects-from-lldb/" itemprop="url">Visualising CGRects and NSRects from lldb with drawrect</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Halfway through debugging the new enumeration engine for <a href="https://shortcatapp.com/">Shortcat</a>, I realised I needed a way to visualise <code>CGRect</code>/<code>NSRect</code>s while debugging. Trying to figure out how one <code>CGRect</code> relates to another by looking at four numbers is a PITA.</p>

<p>I decided to write a tool to solve this problem. I also took the chance to actually develop an app with <a href="http://rubymotion.com">RubyMotion</a>.</p>

<h2>Introducing <code>drawrect</code></h2>

<p><a href="https://github.com/chendo/drawrect"><code>drawrect</code></a> is a command line tool for OS X that simply draws translucent rectangles on the screen.</p>

<p><img src="https://github.com/chendo/drawrect/raw/master/screenshot.png" alt="Screenshot" /></p>

<p>You can use it from within <code>lldb</code> (provided you installed the scripts) or from the command line.</p>

<h2>Usage</h2>

<h4>Within <code>lldb</code></h4>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>dr &lt;rect expression&gt;     # This will get the string representation of
</span><span class='line'>                         # the rect returned by the expression and draw it
</span><span class='line'>
</span><span class='line'>dr window.frame          # This will draw a rect of the window's frame
</span><span class='line'>
</span><span class='line'>drf &lt;rect expression&gt;    # This is the same as above, but where the origin
</span><span class='line'>                         # of the rect is from the top left
</span><span class='line'>
</span><span class='line'>dc                       # Removes all the rects</span></code></pre></td></tr></table></div></figure>


<h4>Command line</h4>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>drawrect rect &lt;rect&gt; <span class="o">[</span>label<span class="o">]</span> <span class="o">[</span>colour<span class="o">]</span> <span class="o">[</span>opacity<span class="o">]</span>           <span class="c"># Draws a rect at &lt;rect&gt; coordinates with [label], background colour in hex [colour] with opacity [opacity]</span>
</span><span class='line'>drawrect flipped_rect &lt;rect&gt; <span class="o">[</span>label<span class="o">]</span> <span class="o">[</span>colour<span class="o">]</span> <span class="o">[</span>opacity<span class="o">]</span>   <span class="c"># Same as above, but from top-left origin</span>
</span><span class='line'>
</span><span class='line'>drawrect rect 100,100,100,100 Hello 00ff00 0.3            <span class="c"># Draws a rect at origin 100,100 with size 100,100, text &quot;Hello&quot;, translucent green background</span>
</span><span class='line'>drawrect clear     <span class="c"># Clears rect</span>
</span><span class='line'>drawrect quit      <span class="c"># Quits the drawrect process</span>
</span><span class='line'>drawrect <span class="nb">help</span>      <span class="c"># Shows help</span>
</span><span class='line'>drawrect version   <span class="c"># Shows version</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Future improvements</h2>

<p>I couldn&rsquo;t find a way to hook into process termination or resuming in <code>lldb</code>, so you would have to clear the rects manually with <code>drc</code> in <code>lldb</code>. If someone knows how to do this, please let me know in the comments!</p>

<p>I&rsquo;d like to add a feature where you could hover over a <code>CGRect</code> or <code>NSRect</code> in the Variable view and it would highlight, but I&rsquo;m not sure how to do this without resorting to Accessibility.</p>

<p>I hope <code>drawrect</code> is useful to others! Let me know if this has been useful to you.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-09-30T14:01:00+10:00" data-updated="true" itemprop="datePublished">Sep 30<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/debugging/'>debugging</a>, <a class='category' href='/blog/categories/objective-c/'>objective-c</a>, <a class='category' href='/blog/categories/xcode/'>xcode</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/09/30/selectively-ignoring-objective-c-exceptions-in-xcode/" itemprop="url">Selectively ignoring Objective-C exceptions in Xcode</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p><strong>Edit &ndash; Octorber 9, 2013:</strong> Updated the script to support iOS Simulator (i386) and iPhone 5S (ARM 64bit).</p>

<p>Xcode has the ability to break on all Objective-C exceptions (<code>Debug &gt; Breakpoints &gt; Create Exception Breakpoint...</code>), which is extremely useful as you can see the exception before the stack unwinds.</p>

<p>However, enabling this option will cause Xcode to break whenever an exception occurs (even when inside a <code>@try/@catch</code> block), making it hard to track down the exception you&rsquo;re actually after when you&rsquo;re working with exception-heavy frameworks like CoreData or Accessibility. Also, Cocoa frameworks sometimes throws exceptions internally, which can be confusing as you wouldn&rsquo;t see an exception at your code otherwise.</p>

<p>This was annoying me today while I was working on <a href="http://shortcatapp.com/">Shortcat</a> as Accessibility really likes throwing exceptions, so I wrote a <a href="https://gist.github.com/chendo/6759305">lldb script</a> that lets you easily specify what exceptions to ignore based on any selector on <code>NSException</code>. I based it off <a href="http://qwan.org/2013/06/18/how-to-snatch-the-error-code-from-the-trap-frame-in-xcode/">Rob Mayoff&rsquo;s <code>sniff_objc_exception_throw</code> script</a> as there wasn&rsquo;t really much in way of <code>lldb</code> documentation.</p>

<h2>Setup</h2>

<ul>
<li>Grab the script from <a href="https://gist.github.com/chendo/6759305/raw/ignore_specified_objc_exceptions.py">here</a></li>
<li>Put this script somewhere (eg. <code>~/Library/lldb/ignore_specified_objc_exceptions.py</code>)</li>
<li>Add this to your <code>~/.lldbinit</code>:
<code>command script import &lt;path to ignore_specified_objc_exceptions.py&gt;</code></li>
</ul>


<h4>But I&rsquo;m lazy!</h4>

<figure class='code'><figcaption><span>for-the-lazy.sh</span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -p ~/Library/lldb
</span><span class='line'>curl -L https://gist.github.com/chendo/6759305/raw/ignore_specified_objc_exceptions.py &gt; ~/Library/lldb/ignore_specified_objc_exceptions.py
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;command script import ~/Library/lldb/ignore_specified_objc_exceptions.py&quot;</span> &gt;&gt; ~/.lldbinit
</span></code></pre></td></tr></table></div></figure>


<h2>Usage</h2>

<ul>
<li>In Xcode, add a breakpoint to catch all Objective-C exceptions</li>
<li>Edit the breakpoint and add a Debugger Command with the following command:
<code>ignore_specified_objc_exceptions name:NSAccessibilityException className:NSSomeException</code></li>
<li>This will ignore exceptions where <code>NSException</code> <code>-name</code> matches <code>NSAccessibilityException</code> OR <code>-className</code> matches <code>NSSomeException</code></li>
</ul>


<p>It should look something like this:</p>

<p><img src="http://f.cl.ly/items/3f3S3q3D2L0o1y2t0F2i/Screen%20Shot%202013-09-30%20at%202.52.39%20PM.png" alt="Screenshot" /></p>

<p>Let me know if you have any issues!</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-09-16T12:57:00+10:00" data-updated="true" itemprop="datePublished">Sep 16<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/sublime-text/'>sublime text</a>, <a class='category' href='/blog/categories/workflow/'>workflow</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/09/16/editing-files-on-a-remote-server-with-sublime-text-2/" itemprop="url">Editing files on a remote server with Sublime Text 2</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>I&rsquo;ve always hated editing files on a remote machine over SSH. I&rsquo;m not a huge fan of vim, and nano is terrible for anything remotely (hah, get it?) complex.</p>

<p>Being able to use your local editor with all your plugins and everything all set up would be ideal. However, each solution tends to have its caveats.</p>

<h1>SFTP</h1>

<p>You can use SFTP to access the server with an app like <a href="http://panic.com/transmit">Transmit</a> and then editing the file.</p>

<h2>Pros</h2>

<ul>
<li>Easiest solution</li>
<li>Able to browse directory tree</li>
</ul>


<h2>Cons</h2>

<ul>
<li>Generally limited to your user &ndash; editing root-owned files requires logging in as root</li>
<li>Non-ideal workflow &ndash; switch out of the shell to navigate to the file in the app</li>
</ul>


<h1>SSHFS/FUSE</h1>

<p>You can mount a server over SSH with something like <a href="http://osxfuse.github.io">FUSE for OS X</a>, then editing the file by navigating the mounted filesystem.</p>

<h2>Pros</h2>

<ul>
<li>Able to browse directory tree</li>
<li>Fairly easy to set up</li>
</ul>


<h2>Cons</h2>

<ul>
<li>Generally limited to your user &ndash; editing root-owned files is difficult</li>
<li>Can be slow &ndash; Finder tends to enumerate metadata you don&rsquo;t care about</li>
<li>Non-ideal workflow &ndash; switch out of the shell to navigate to the file in the app</li>
</ul>


<h1>rsub</h1>

<p><a href="https://github.com/Drarok/rsub"><code>rsub</code></a> is a package for Sublime Text 2 which is a port of <code>rmate</code> functionality in Textmate 2. It utilises a script installed on the remote machine which communicates with your local machine over a remote forwarded port.</p>

<h2>Pros</h2>

<ul>
<li>Ideal workflow &ndash; initiate file editing from shell</li>
<li>Usable with sudo &ndash; <code>sudo rsub /etc/nginx/conf/nginx.conf</code> works!</li>
</ul>


<h2>Cons</h2>

<ul>
<li>More effort to set up &ndash; <code>rsub</code> needs to be installed on each machine</li>
<li>Not ideal for servers where untrusted users have access</li>
</ul>


<h2>Setting up <code>rsub</code></h2>

<p>Please note that the <code>rsub</code> package only supports Sublime Text 2 at this point.</p>

<ol>
  <li>
    Install <code>rsub</code> with <a href="http://wbond.net/sublime_packages/package_control">Package Control</a>
  </li>
  <li>Set up ssh port forwarding:
    <ul>
      <li>
        You need to set up a remote forward on port <code>52698</code> (by default)
      </li>
      <li>
        You can do it every time you log in:


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ssh username@server -R 52698:localhost:52698
</span></code></pre></td></tr></table></div></figure>

      </li>
      <li>
        Or you can configure <code>.ssh/config</code>:


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'># You should only do this for servers that you only have
</span><span class='line'># access to as anyone on the server can connect to your machine
</span><span class='line'>Host *.my-company.com
</span><span class='line'>  RemoteForward 52698 127.0.0.1:52698</span></code></pre></td></tr></table></div></figure>

      </li>
    </ul>
  </li>
  <li>
    Install the <code>rsub</code> remote script on your server:

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># aurora&#39;s fork of rmate is a bash script that only works with Linux servers.</span>
</span><span class='line'><span class="c"># See https://github.com/textmate/rmate for a ruby version</span>
</span><span class='line'>sudo wget -O /usr/local/bin/rsub https://raw.github.com/aurora/rmate/master/rmate
</span><span class='line'>sudo chmod +x /usr/local/bin/rsub
</span></code></pre></td></tr></table></div></figure>

  </li>
  <li>
    Use it!

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo rsub /etc/nginx/conf/nginx.conf
</span></code></pre></td></tr></table></div></figure>

  </li>
</ol>




		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-07-07T14:46:00+10:00" data-updated="true" itemprop="datePublished">Jul 7<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/07/07/python-like-docstrings-in-ruby/" itemprop="url">Python-like docstrings in Ruby!</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>About six months ago, I watched Peter Cooper&rsquo;s <a href="http://rubyreloaded.com/trickshots">Ruby Trickshots</a> and learnt that Ruby has an interesting syntax that allows you to concatenate strings by simply placing them after each other.</p>

<p>For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;foo&quot;</span> <span class="s2">&quot;bar&quot;</span> <span class="c1"># =&gt; &quot;foobar&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I quickly realised that that meant that this was valid syntax:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;&quot;&quot;foo&quot;&quot;&quot;</span>   <span class="c1"># =&gt; &quot;foo&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which meant that Python-like docstrings were syntactically valid in Ruby!</p>

<p>I hacked up a bit of code that let you read out the docstring in this gist:</p>

<div><script src='https://gist.github.com/2146319.js'></script>
<noscript><pre><code>class DocStrings
  def docstrings!
    &quot;&quot;&quot;
      This is a docstring that&#39;s syntactically valid!
      It&#39;ll do multiple lines!
    &quot;&quot;&quot;
  end

  def single_line_docstring
    &quot;&quot;&quot;Single line docstring!&quot;&quot;&quot;
  end

  def why?
    &quot;&quot;&quot;
      Cause I can? Duh.
    &quot;&quot;&quot;
  end

  def how_does_it_work?
    &quot;&quot;&quot;
      I learnt that two strings side by side concats them together
      and is valid Ruby from Peter Cooper (@peterc)&#39;s Ruby Trick Shots found
      at http://rubyreloaded.com/trickshots/

      Then the rest is just some good ol&#39; regex.
    &quot;&quot;&quot;
  end

  def notes
    &quot;&quot;&quot;
      Double quotes not together like this: &quot;&quot;
      breaks it.

      Requires Method#source_location

      Code below is unoptimised and needs further work
    &quot;&quot;&quot;
  end

  def no_docstring

  end
end



class Method
  def doc
    @doc ||= begin
      path, line_number = source_location

      return nil unless path &amp;&amp; File.exists?(path)

      file = File.read(path)

      if file =~ Regexp.new(%Q{\\A(?:.*?\n){#{line_number}}\s*?&quot;&quot;&quot;([\\s\\S]+?)&quot;&quot;&quot;})
        $1.gsub(/\n\s+/, &quot;\n&quot;).strip
      else
        nil
      end

    end
  end
end


doc = DocStrings.new
(doc.methods - methods).each do |method_name|
  puts &quot;method name #{method_name.to_s}:&quot;
  puts doc.method(method_name).doc
  puts &quot;----&quot;
end
</code></pre></noscript></div>


<p>It was an interesting hack, but I thought that Ruby would have to evaluate the concatenation on every method invocation, hence adding a performance hit purely to add a docstring, and hence ditched the idea of taking it further, and then promptly forgot about it.</p>

<p>Six months later, I found it when I was going through my old gists. I brought it up with CRuby Master <a href="http://twitter.com/charliesome">@charliesome</a>, and he informed me that CRuby is pretty smart and actually won&rsquo;t emit bytecode if it detects that the literals aren&rsquo;t actually used, so there is actually no performance hit (apart from when it&rsquo;s parsing).</p>

<p>Proof:</p>

<figure class='code'><figcaption><span>https://eval.in/36676 </span><a href='https://eval.in/36676' title='Download code'> Link</a></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">no_docstring</span>
</span><span class='line'>  <span class="kp">nil</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">with_docstring</span>
</span><span class='line'>  <span class="s2">&quot;&quot;&quot;Foo&quot;&quot;&quot;</span>
</span><span class='line'>  <span class="kp">nil</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="ss">RubyVM</span><span class="p">:</span><span class="ss">:InstructionSequence</span><span class="o">.</span><span class="n">of</span><span class="p">(</span><span class="nb">method</span><span class="p">(</span><span class="ss">:no_docstring</span><span class="p">))</span><span class="o">.</span><span class="n">disasm</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;---&quot;</span>
</span><span class='line'><span class="nb">puts</span> <span class="ss">RubyVM</span><span class="p">:</span><span class="ss">:InstructionSequence</span><span class="o">.</span><span class="n">of</span><span class="p">(</span><span class="nb">method</span><span class="p">(</span><span class="ss">:with_docstring</span><span class="p">))</span><span class="o">.</span><span class="n">disasm</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Output:</span>
</span><span class='line'><span class="c1"># == disasm: &lt;RubyVM::InstructionSequence:no_docstring@/tmp/execpad-ecb5745fbd46/source-ecb5745fbd46&gt;</span>
</span><span class='line'><span class="c1"># 0000 trace            8                                               (   1)</span>
</span><span class='line'><span class="c1"># 0002 putnil</span>
</span><span class='line'><span class="c1"># 0003 trace            16                                              (   3)</span>
</span><span class='line'><span class="c1"># 0005 leave</span>
</span><span class='line'><span class="c1"># ---</span>
</span><span class='line'><span class="c1"># == disasm: &lt;RubyVM::InstructionSequence:with_docstring@/tmp/execpad-ecb5745fbd46/source-ecb5745fbd46&gt;</span>
</span><span class='line'><span class="c1"># 0000 trace            8                                               (   5)</span>
</span><span class='line'><span class="c1"># 0002 putnil</span>
</span><span class='line'><span class="c1"># 0003 trace            16                                              (   8)</span>
</span><span class='line'><span class="c1"># 0005 leave</span>
</span></code></pre></td></tr></table></div></figure>


<p>I made a gem called <a href="https://github.com/chendo/docstrings">docstrings</a> that allows accessing docstrings via <code>Method#docstring</code>. I&rsquo;m not entirely sure how useful this actually is, so let me know if you end up using it.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-06-03T20:59:00+10:00" data-updated="true" itemprop="datePublished">Jun 3<span>rd</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/ruby/'>ruby</a>, <a class='category' href='/blog/categories/rubymotion/'>rubymotion,</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/06/03/running-individual-specs-with-rubymotion/" itemprop="url">Running individual specs with RubyMotion</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>I&rsquo;m testing parts of <a href="http://shortcatapp.com/">Shortcat</a> (which as of v0.4.0 is in Objective-C) with <a href="http://www.rubymotion.com/">RubyMotion</a>, which is pretty nifty since I&rsquo;m much more comfortable in Ruby than Objective-C and writing tests is way easier in Ruby. However, it&rsquo;s far from the fully-featured <a href="http://rspec.info/">RSpec</a> like I&rsquo;m used to.</p>

<p>When working on a class, I like to only run specs for that particular file to keep the runtimes down, then run all the specs later. In RubyMotion, you can achieve this with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rake spec <span class="nv">files</span><span class="o">=</span>foo_spec,spec/bar_spec.rb
</span></code></pre></td></tr></table></div></figure>


<p>(via <a href="http://www.rubymotion.com/developer-center/articles/testing/#_run_selected_spec_files">http://www.rubymotion.com/developer-center/articles/testing/#_run_selected_spec_files</a></p>

<p>However, I couldn&rsquo;t see any obvious way to run individual specs, which is useful when trying to focus on a particular spec. So I dug into the <code>spec.rb</code> in <code>/Library/RubyMotion/lib/motion/</code>, which seems to be just a copy of <a href="https://github.com/alloy/MacBacon">MacBacon</a>, and found this:</p>

<figure class='code'><figcaption><span>/Library/RubyMotion/lib/motion/bacon.rb</span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Bacon</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">RestrictName</span>    <span class="o">=</span> <span class="sr">//</span>  <span class="k">unless</span> <span class="n">defined?</span> <span class="no">RestrictName</span>
</span><span class='line'>  <span class="no">RestrictContext</span> <span class="o">=</span> <span class="sr">//</span>  <span class="k">unless</span> <span class="n">defined?</span> <span class="no">RestrictContext</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Backtraces</span> <span class="o">=</span> <span class="kp">true</span>  <span class="k">unless</span> <span class="n">defined?</span> <span class="no">Backtraces</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>





		
		<a href="/blog/2013/06/03/running-individual-specs-with-rubymotion/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-06-02T15:17:00+10:00" data-updated="true" itemprop="datePublished">Jun 2<span>nd</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/cocoa/'>cocoa</a>, <a class='category' href='/blog/categories/objective-c/'>objective-c</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/06/02/showing-the-crash-dialog-for-backgrounded-cocoa-apps/" itemprop="url">Showing the Crash Dialog for Backgrounded Cocoa Apps</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>While developing <a href="http://shortcatapp.com">Shortcat</a>, I ran into an extremely annoying problem with <code>LSUIElement</code> apps: They crash silently, giving the user no indication that it has crashed. This is especially bad when you don&rsquo;t have any visual indicator that it&rsquo;s running.</p>

<p>This <a href="http://stackoverflow.com/questions/10359966/crashreporter-dialog-doesnt-show-when-mac-app-crashes">post on StackOverflow</a> says that you can use <code>CrashReporterPrefs.app</code> to enable developer mode so it would show the dialog when a backgrounded app crashes. However, this is still a bad experience for end users.</p>

<p>My first attempt at fixing this was to install my own signal handlers so it would bring the application into the foreground, remove the handler, then reraise the signal:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="kt">void</span> <span class="nf">BringAppToForeground</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">ProcessSerialNumber</span> <span class="n">psn</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kCurrentProcess</span> <span class="p">};</span>
</span><span class='line'>    <span class="n">TransformProcessType</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psn</span><span class="p">,</span> <span class="n">kProcessTransformToForegroundApplication</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">SignalHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">signal</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Signal caught: %d&quot;</span><span class="p">,</span> <span class="n">signal</span><span class="p">);</span>
</span><span class='line'>    <span class="n">BringAppToForeground</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Restore default handler</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sigaction</span> <span class="n">action</span><span class="p">;</span>
</span><span class='line'>    <span class="n">action</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="n">SIG_DFL</span><span class="p">;</span>
</span><span class='line'>    <span class="n">action</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">action</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sigaction</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">action</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">raise</span><span class="p">(</span><span class="n">signal</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">InstallSignalHandlers</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sigaction</span> <span class="n">action</span><span class="p">;</span>
</span><span class='line'>    <span class="n">action</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">SignalHandler</span><span class="p">;</span>
</span><span class='line'>    <span class="n">action</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">action</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sigaction</span><span class="p">(</span><span class="n">SIGABRT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">action</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sigaction</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">action</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sigaction</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">action</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sigaction</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">action</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sigaction</span><span class="p">(</span><span class="n">SIGBUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">action</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sigaction</span><span class="p">(</span><span class="n">SIGTRAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">action</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Call InstallSignalHandlers while initialising the app</span>
</span></code></pre></td></tr></table></div></figure>


<p>This worked well. When the app crashed, the dock icon showed up for a second, then the crash dialogue showed up.</p>

<p>However, I noticed that the <a href="http://hockeyapp.net/">HockeyApp</a> crash reporting was no longer working, probably due to <code>PLCrashReporter</code> also using signal handlers for its own crash handling and I was overriding them.</p>

<p>This is what I came up with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="kt">void</span> <span class="nf">BringAppToForeground</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">ProcessSerialNumber</span> <span class="n">psn</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kCurrentProcess</span> <span class="p">};</span>
</span><span class='line'>    <span class="n">TransformProcessType</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psn</span><span class="p">,</span> <span class="n">kProcessTransformToForegroundApplication</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="n">fatal_signals</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SIGABRT</span><span class="p">,</span>
</span><span class='line'>    <span class="n">SIGBUS</span><span class="p">,</span>
</span><span class='line'>    <span class="n">SIGFPE</span><span class="p">,</span>
</span><span class='line'>    <span class="n">SIGILL</span><span class="p">,</span>
</span><span class='line'>    <span class="n">SIGSEGV</span><span class="p">,</span>
</span><span class='line'>    <span class="n">SIGTRAP</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="n">n_fatal_signals</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">fatal_signals</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fatal_signals</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span><span class='line'><span class="k">static</span> <span class="k">struct</span> <span class="n">sigaction</span> <span class="n">original_handlers</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span> <span class="c1">// Must set this to the same number of fatal_signals</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">SignalHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">signal</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">BringAppToForeground</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Restore PLCrashreporter&#39;s handlers</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">n_fatal_signals</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">sigaction</span><span class="p">(</span><span class="n">fatal_signals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">original_handlers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">raise</span><span class="p">(</span><span class="n">signal</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">InstallSignalHandlers</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sigaction</span> <span class="n">action</span><span class="p">;</span>
</span><span class='line'>    <span class="n">action</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">SignalHandler</span><span class="p">;</span>
</span><span class='line'>    <span class="n">action</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">action</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sigaction</span> <span class="n">default_action</span><span class="p">;</span>
</span><span class='line'>    <span class="n">default_action</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="n">SIG_DFL</span><span class="p">;</span>
</span><span class='line'>    <span class="n">default_action</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">default_action</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Store the original handlers</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sigaction</span> <span class="n">original_handler</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">n_fatal_signals</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">sigaction</span><span class="p">(</span><span class="n">fatal_signals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">original_handler</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">original_handlers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_handler</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">original_handlers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_action</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">sigaction</span><span class="p">(</span><span class="n">fatal_signals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">action</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ideally, it would be better if PLCrashReporter supported some sort of callback so you can perform your own actions before it crashes, but I&rsquo;d say a lot of people would try to call Objective-C code within it, making the crash handling not as reliable.</p>

<p>Please let me know if there&rsquo;s ways to improve on this!</p>

		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright &copy; 2018 - chendo -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span><br>
  <span class="credit">Sponsored by <a href="https://tryst.link">Tryst</a>.
</p>

Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'chendo';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-110306-6']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>




		</div>
	</div>
</body>
</html>
